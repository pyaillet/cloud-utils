resources:
## Masters
- type: compute.v1.instanceTemplate
  name: master-template
  properties:
    properties:
      machineType: n1-standard-1
      scheduling:
        preemptible: true
      networkInterfaces:
      - network: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/networks/default
        accessConfigs:
        - name: External NAT
          type: ONE_TO_ONE_NAT        
      disks:
      - deviceName: boot
        type: PERSISTENT
        boot: true
        autoDelete: true
        initializeParams:
          sourceImage: https://www.googleapis.com/compute/v1/projects/ubuntu-os-cloud/global/images/family/ubuntu-1804-lts
      namedPorts:
      - name: api-server
        port: 6443
      metadata:
        items:
          - key: startup-script
            value: >
              #!/bin/bash
              sudo apt-get update
              sudo apt-get install -y \
                apt-transport-https \
                ca-certificates \
                curl \
                software-properties-common
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
              sudo add-apt-repository -y \
                "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
                $(lsb_release -cs) \
                edge"
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-compose
              sudo usermod -aG docker ubuntu
- type: compute.v1.targetPools
  name: master-pool
  properties:
    region: europe-west1
- type: compute.v1.instanceGroupManagers
  name: master-group
  properties:
    zone: europe-west1-c
    baseInstanceName: master
    targetSize: 3
    instanceTemplate: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/instanceTemplates/master-template
    targetPools:
    - https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/targetPools/master-pool
## Workers  
- type: compute.v1.instanceTemplate
  name: worker-template
  properties:
    properties:
      machineType: n1-standard-1
      scheduling:
        preemptible: true
      networkInterfaces:
      - network: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/networks/default
        accessConfigs:
        - name: External NAT
          type: ONE_TO_ONE_NAT   
      disks:
      - deviceName: boot
        type: PERSISTENT
        boot: true
        autoDelete: true
        initializeParams:
          sourceImage: https://www.googleapis.com/compute/v1/projects/ubuntu-os-cloud/global/images/family/ubuntu-1804-lts
      namedPorts:
      - name: api-server
        port: 6443
      metadata:
        items:
          - key: startup-script
            value: >
              #!/bin/bash
              sudo apt-get update
              sudo apt-get install -y \
                apt-transport-https \
                ca-certificates \
                curl \
                software-properties-common
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
              sudo add-apt-repository -y \
                "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
                $(lsb_release -cs) \
                edge"
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-compose
              sudo usermod -aG docker ubuntu
- type: compute.v1.targetPools
  name: worker-pool
  properties:
    region: europe-west1
- type: compute.v1.instanceGroupManagers
  name: worker-group
  properties:
    zone: europe-west1-c
    baseInstanceName: worker
    targetSize: 3
    instanceTemplate: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/instanceTemplates/worker-template
    targetPools:
    - https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/targetPools/worker-pool
## Load balancer
- type: compute.v1.httpsHealthChecks
  name: api-server-basic-check
  properties:
    port: 6443
- type: compute.v1.backendServices
  name: master-backend
  properties:
    protocol: HTTPS
    healthChecks:
    - https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/httpsHealthChecks/api-server-basic-check
    backends:
    - description: master-backend
      group: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/instanceGroup/master-group
- type: compute.v1.urlMaps
  name: api-server-map
  properties:
    defaultService: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/backendServices/master-backend
- type: compute.v1.targetHttpsProxies
  name: api-server-lb-proxy
  properties:
    urlMap: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/urlMaps/api-server-map
- type: compute.v1.forwardingRules
  name: api-server-content-rule
  properties:
    region: europe-west1
    target: https://www.googleapis.com/compute/v1/projects/training-k8s-180409/global/targetHttpsProxies/api-server-lb-proxy
    ports:
    - 6443